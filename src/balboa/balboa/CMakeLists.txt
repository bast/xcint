set(_generated_files
    ${PROJECT_BINARY_DIR}/generated/autogenerated.h
    ${PROJECT_BINARY_DIR}/generated/parameters.h
    ${PROJECT_BINARY_DIR}/generated/offsets.h
    ${PROJECT_BINARY_DIR}/generated/ao_dispatch.cpp
    ${PROJECT_BINARY_DIR}/generated/ao_dispatch.h
    )

foreach(_suffix block explicit)
    foreach(_level RANGE 0 ${MAX_GEO_DIFF_ORDER})
        set(_generated_files
            ${_generated_files}
            ${PROJECT_BINARY_DIR}/generated/autogenerated_${_level}_${_suffix}.cpp
            )
    endforeach()
endforeach()

file(MAKE_DIRECTORY ${PROJECT_BINARY_DIR}/generated)

# generate AO evaluation code
execute_process(
  COMMAND
    ${PYTHON_EXECUTABLE} ${PROJECT_SOURCE_DIR}/balboa/generate.py
                         ${PROJECT_BINARY_DIR}/generated
                         ${MAX_L_VALUE}
                         ${AO_CHUNK_LENGTH}
                         ${MAX_GEO_DIFF_ORDER}
  )
set_source_files_properties(${_generated_files} PROPERTIES GENERATED 1)

# the above is a workaround to prevent sources to be regenerated at each build
# which is very annoying since release build then takes forever
#add_custom_command(
#    OUTPUT
#        ${_generated_files}
#    COMMAND
#        ${PYTHON_EXECUTABLE} ${PROJECT_SOURCE_DIR}/balboa/generate.py
#                             ${PROJECT_BINARY_DIR}/generated
#                             ${MAX_L_VALUE}
#                             ${AO_CHUNK_LENGTH}
#                             ${MAX_GEO_DIFF_ORDER}
#    DEPENDS
#        generate.py
#        cs_trans.py
#        ${PROJECT_SOURCE_DIR}/cmake/custom/parameters.cmake
#    )

add_library(
    balboa
    SHARED
    Main.cpp
    Main.h
    ao_vector.cpp
    ao_vector.h
    ${_generated_files}
    )

target_include_directories(
    balboa
    PUBLIC
    ${PROJECT_SOURCE_DIR}/balboa
    ${PROJECT_BINARY_DIR}/generated
    ${PROJECT_BINARY_DIR}/include
    )

install(TARGETS balboa LIBRARY DESTINATION lib)
install(FILES ${PROJECT_BINARY_DIR}/include/balboa.h DESTINATION include)
install(FILES ${PROJECT_BINARY_DIR}/include/balboa_export.h DESTINATION include)
